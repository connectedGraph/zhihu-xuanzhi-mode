# 🛠️ 知乎宣纸模式 - 核心技术实现文档

## 1. 架构概述

本脚本的核心思想是 **“DOM 劫持与视觉隔离”**。由于知乎采用 React 框架构建，强行破坏其 DOM 结构会导致页面崩溃或功能失效。因此，脚本采用“非破坏性提取”与“原位占位”策略，在不打断 React 虚拟 DOM 树生命周期的前提下，实现视觉层面的完全重构。

## 2. 核心挑战与技术演进

### 挑战一：如何实现“无损、无缝”的模式切换？

* **早期痛点**：最初的退出逻辑依赖 `window.location.reload()` 刷新页面，这会导致用户丢失阅读进度，体验极差。
* **最终解法（GPS 占位符模式）**：
在将“文章主体（`.Post-Main`）”和“操作栏”从原网页拔出、放入宣纸容器之前，先使用 `document.createElement('span')` 在它们的**原物理位置**埋下隐藏的占位符（Placeholder）。
当用户按下 `Ctrl + E` 退出时，脚本会按图索骥，将文章和操作栏精准插入回占位符的前面，随后再销毁宣纸容器。这就实现了**“拔出 -> 渲染新视图 -> 塞回原处”**的闭环，彻底告别刷新。

### 挑战二：DOM 销毁的“先后顺序”灾难

* **早期痛点**：在早期的“收卷（退出）”逻辑中，先执行了 `wrapper.remove()`（销毁宣纸），然后再试图去寻找文章节点将其归位。这导致文章随着宣纸一起被销毁，退回原版后页面变成了一片空白。
* **最终解法（全局引用与护送机制）**：
1. 在全局声明 `let _articleNode` 变量，死死捏住文章节点的内存引用。
2. 严格遵循**“先下船，后炸船”**的逻辑：在退出沉浸时，**必须先**将 `_articleNode` 护送回原网页的占位符处，**最后**才能调用 `remove()` 销毁宣纸和 CSS 样式。



### 挑战三：React 事件流丢失与按钮变形

* **早期痛点**：为了让知乎原生的“目录”按钮悬浮在页面右下角，我们曾尝试将其 DOM 节点 `appendChild` 移动到 `body` 最外层。结果导致按钮变成了“死按钮”（无法点击），且强加的 `border-radius: 50%` 使其变成了丑陋的椭圆形。
* **技术溯源**：知乎使用 React。React 的 `onClick` 事件并非绑定在真实 DOM 上，而是通过事件代理挂载在根节点。当把目录按钮强行移出其原本的组件树时，它就脱离了 React 的事件合成机制，导致失效。
* **最终解法（纯 CSS 视觉传送）**：
* **放弃 DOM 移动**：保留目录按钮在原生 HTML 树中的绝对位置，坚决不使用 `appendChild` 移动它，从而完美保留了 React 的内部状态和点击事件。
* **CSS 劫持**：给它强行注入一个自定义的 class `.zh-toc-fixed-style`，利用 `position: fixed !important; top: 30px; right: 30px;` 在**视觉层**将其“传送”到屏幕右上角。
* **UI 重构**：废弃圆角，采用 `border-radius: 4px;` 配合 `width: auto`，将其塑造成一个精致的古风方印，完美契合整体视觉。



### 挑战四：视觉沉浸与眼部舒适度

* **视觉优化**：
* **背景降噪**：如果宣纸外围是全黑或高对比度颜色，会造成强烈的视觉割裂。我们最终选定了低对比度的“旧麻布色”（`#E5DEC9`）作为 `body` 背景，与宣纸本体（`#F8F4E6`）形成柔和的过渡。
* **障眼法（隐藏原生元素）**：除了被提取的主体文章，原网页的顶栏、侧边栏并未被删除，而是被遍历加上了 `display: none` 和 `.zh-hidden-by-immersive` 标记。退出时一键剥离该标记，瞬间恢复原生态。



## 3. 总结

本方案通过 **“占位符定海神针” + “DOM 引用内存锁定” + “纯 CSS 视觉传送”** 三大核心手段，巧妙绕过了 React 框架的限制，在不破坏任何原生功能的前提下，完成了一次极具美感的前端 Hack，实现了真正意义上的“热插拔”式阅读体验。